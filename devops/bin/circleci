#!/bin/zsh

set -e

SCRIPTPATH="$( cd "$(dirname "$0")" ; pwd -P )"

pushd $SCRIPTPATH/../..

source $SCRIPTPATH/../config

direnv allow .

eval "$(direnv export bash)"

# Let's renew our token
vault token renew

# VAULT_TOKEN has the value of a generic token (circleci-global-policy) stored
# in circleci project settings. We use it to get a more specific token, used
# for this environment.
export VAULT_TOKEN=$(vault write -format=json auth/token/create/$CIRCLECI_ROLE \
  policies=$CIRCLECI_POLICY \
  policies=$VAULT_READ_API_POLICY \
  ttl=1h |
  jq -r '.auth.client_token')

if [[ "$1" == "deploy" ]]; then
  k8s_auth circleci
  deploy
fi

popd
