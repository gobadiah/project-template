#!/bin/zsh

SCRIPTPATH="$( cd "$(dirname "$0")" ; pwd -P )"

source $SCRIPTPATH/../../config

pushd $SCRIPTPATH/..

### Cluster specific policies
# These must be created each time a cluster is created.

## General
# read the api host
vault write sys/policy/$VAULT_READ_API_POLICY \
  policy="$(cat policies/read_api.hcl | sed "s#PATH#$VAULT_CLUSTER_PATH#")"

## Circleci
# Ability to create a circleci on any k8s cluster
vault write sys/policy/$CIRCLECI_POLICY \
  policy="$(cat policies/circleci.hcl | sed "s/CLUSTER_NAME/$CLUSTER_NAME/")"

# Cluster specific circleci role
vault write auth/token/roles/$CIRCLECI_ROLE \
  allowed_policies="$CIRCLECI_POLICY,$VAULT_READ_API_POLICY"

# Cluster specific kubernetes role
vault write $VAULT_K8S_PATH/roles/circleci allowed_domains=circleci allow_bare_domains=true ttl=1h

popd
